#!/bin/bash

# ==============================================
# Step 030: Application Setup
# ==============================================

set -e

log "Application Setup"

# Define application directory
APP_DIR="$HOME/zerogex-web"

# Check if application directory already exists
if [ -d "$APP_DIR" ]; then
    log "  → Application directory exists, pulling latest changes..."
    cd "$APP_DIR"
    git pull
else
    log "  → Cloning repository..."
    cd "$HOME"
    
    # Prompt for git repository URL
    read -p "  Enter git repository URL: " GIT_REPO
    while [ -z "$GIT_REPO" ]; do
        echo "     ✗ Repository URL cannot be empty"
        read -p "  Enter git repository URL: " GIT_REPO
    done
    
    git clone "$GIT_REPO" zerogex-web
    cd "$APP_DIR"
fi

# Navigate to frontend directory
log "  → Navigating to frontend directory..."
cd "$APP_DIR/frontend"

# Load nvm
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Use Node 20
nvm use 20

# Install dependencies
log "  → Installing npm dependencies..."
npm install

# Clear Next.js build cache for clean build
log "  → Clearing Next.js build cache..."
rm -rf .next

# Prompt for domain name for .env.local
read -p "  Enter your domain name for API configuration (e.g., zerogex.io): " DOMAIN_NAME
while [ -z "$DOMAIN_NAME" ]; do
    echo "     ✗ Domain name cannot be empty"
    read -p "  Enter your domain name: " DOMAIN_NAME
done

# Create .env.local with proper API URLs
log "  → Creating .env.local file..."
cat > .env.local << EOF
# API Configuration
# Base URL without /api suffix (hooks add /api/ automatically)
# Uses relative URLs through nginx proxy - no need for localhost:8000
NEXT_PUBLIC_API_URL=https://$DOMAIN_NAME
NEXT_PUBLIC_WS_URL=wss://$DOMAIN_NAME/ws

# Feature Flags
NEXT_PUBLIC_ENABLE_WEBSOCKET=false
NEXT_PUBLIC_ENABLE_GRAFANA=false
EOF
chmod 600 .env.local
log "     ✓ .env.local created with API URL: https://$DOMAIN_NAME"

# Build for production
log "  → Building application for production..."
npm run build

log ""
log "Application setup complete!"
log ""
log "Summary:"
log "  ✓ Repository cloned/updated"
log "  ✓ Dependencies installed"
log "  ✓ Production build created"
log "  ✓ .env.local configured for domain: $DOMAIN_NAME"
log "  ✓ API will be proxied through nginx at /api"
log ""
