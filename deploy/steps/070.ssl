#!/bin/bash

# ==============================================
# Step 070: SSL/HTTPS Setup with Let's Encrypt
# ==============================================

set -e

log "SSL/HTTPS Setup with Let's Encrypt"

# Get domain name from nginx config
DOMAIN_NAME=$(grep "server_name" /etc/nginx/sites-available/zerogex-web | awk '{print $2}' | sed 's/;//' | head -1)

if [ -z "$DOMAIN_NAME" ]; then
    log "  ✗ Could not determine domain name from nginx config"
    read -p "  Enter your domain name: " DOMAIN_NAME
fi

log "  → Domain: $DOMAIN_NAME"

# Prompt for email
read -p "  Enter email for Let's Encrypt notifications: " EMAIL
while [ -z "$EMAIL" ]; do
    echo "     ✗ Email cannot be empty"
    read -p "  Enter email: " EMAIL
done

# Install certbot
log "  → Installing certbot..."
sudo apt install -y certbot python3-certbot-nginx

# Obtain SSL certificate
log "  → Obtaining SSL certificate..."
log "     This will modify your nginx configuration automatically"

if sudo certbot --nginx -d "$DOMAIN_NAME" -d "www.$DOMAIN_NAME" --non-interactive --agree-tos -m "$EMAIL"; then
    log "     ✓ SSL certificate obtained successfully!"
else
    log "     ✗ Failed to obtain SSL certificate"
    log ""
    log "Common issues:"
    log "  • Domain DNS not pointing to this server yet"
    log "  • Port 80/443 not open in firewall (UFW)"
    log "  • Domain not resolving correctly"
    log ""
    log "You can retry this step later with:"
    log "  sudo certbot --nginx -d $DOMAIN_NAME -d www.$DOMAIN_NAME"
    exit 1
fi

# Certbot may have modified the config - verify API proxy is still there
log "  → Verifying API proxy configuration..."
if ! grep -q "location /api/" /etc/nginx/sites-available/zerogex-web; then
    log "  ⚠ API proxy was removed by certbot, restoring..."

    # Get the HTTPS server block and add API proxy before the location / block
    sudo sed -i '/location \/ {/i\    # API proxy to backend (port 8000)\n    location /api/ {\n        proxy_pass http://localhost:8000/api/;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection '"'"'upgrade'"'"';\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_connect_timeout 60s;\n        proxy_send_timeout 60s;\n        proxy_read_timeout 60s;\n    }\n\n    # WebSocket proxy to backend\n    location /ws {\n        proxy_pass http://localhost:8000/ws;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n' /etc/nginx/sites-available/zerogex-web

    # Reload nginx
    sudo systemctl reload nginx
    log "     ✓ API proxy restored"
fi

# Test automatic renewal
log "  → Testing automatic renewal..."
sudo certbot renew --dry-run

log ""
log "SSL setup complete!"
log ""
log "Summary:"
log "  ✓ SSL certificate obtained for: $DOMAIN_NAME"
log "  ✓ Nginx configured for HTTPS"
log "  ✓ API proxy verified at /api"
log "  ✓ WebSocket proxy verified at /ws"
log "  ✓ Automatic renewal configured"
log ""
log "Your site is now accessible at:"
log "  https://$DOMAIN_NAME"
log "  API: https://$DOMAIN_NAME/api"
log "  WebSocket: wss://$DOMAIN_NAME/ws"
log ""
